name: Sliver_ARM64_Ultimate_Victory
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: BishopFox/sliver
          fetch-depth: 1

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Force Assets & Build
        env:
          CGO_ENABLED: 0
          GOOS: linux
          GOARCH: arm64
        run: |
          # الانتقال لمجلد السيرفر
          cd server
          
          # 1. حقن ملف assets وهمي في كل المجلدات التي تطلبه
          # هذه الحركة هي "المفتاح" الذي سيفتح الحصن
          for dir in $(grep -r "assetsFs" . | cut -d: -f1 | xargs -n1 dirname | sort -u); do
            mkdir -p $dir/assets
            echo "package $(basename $dir)" > $dir/assets.go
            echo "import \"embed\"" >> $dir/assets.go
            echo "//go:embed assets/*" >> $dir/assets.go
            echo "var assetsFs embed.FS" >> $dir/assets.go
            touch $dir/assets/placeholder
          done

          # 2. بناء السيرفر بتوقيع فريد (Stealth)
          go mod download
          go build -v -trimpath -ldflags "-s -w -buildid=" -o ../sliver-server-arm64 .

      - name: Upload Finished Weapon
        uses: actions/upload-artifact@v4
        with:
          name: sliver-final-arm64
          path: sliver-server-arm64
